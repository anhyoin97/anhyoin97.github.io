---
title: "8ì¼ì°¨ Spring Security, JWT í† í°ë°©ì‹ ë¡œê·¸ì¸ êµ¬í˜„"
date: 2025-05-06 21:00:00 +0900
categories: ["í† ì´í”„ë¡œì íŠ¸ ì¼ê¸° : MES"]
tags: [Spring Boot, JPA, MySQL, JWT, Spring Security]
---

## ğŸ¯ ì˜¤ëŠ˜ì˜ ëª©í‘œ

MES ì‹œìŠ¤í…œì— ì‚¬ìš©ì ì¸ì¦ ê¸°ëŠ¥ì„ ì¶”ê°€í•˜ê¸° ìœ„í•´ JWT ê¸°ë°˜ ë¡œê·¸ì¸ ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ë ¤ê³  í•œë‹¤.  
ìš°ì„  MySQL ì‚¬ìš©ì í…Œì´ë¸” êµ¬ì¡°ë¶€í„° ì •ë¦¬í•˜ê³ , ì´í›„ Spring Bootì—ì„œ JWT ì¸ì¦ì„ ì—°ë™í•  ê³„íšì´ë‹¤.

---
## âœ… ê¸°ì¡´ `user` í…Œì´ë¸” ì‚­ì œ

MySQLì—ì„œëŠ” `user`ê°€ ì˜ˆì•½ì–´ë¡œ ì“°ì´ê¸° ë•Œë¬¸ì—, í…Œì´ë¸”ëª… ì¶©ëŒ ë° í˜¼ë€ì„ í”¼í•˜ê¸° ìœ„í•´ ê¸°ì¡´ í…Œì´ë¸”ì„ ì‚­ì œí–ˆë‹¤.

```sql
DROP TABLE user;
```

## âœ… users í…Œì´ë¸” ìƒˆë¡œ ìƒì„±
JWT ì¸ì¦ì„ ìœ„í•´ í•„ìš”í•œ ìµœì†Œí•œì˜ ì‚¬ìš©ì ì •ë³´ë§Œ ë‹´ì€ í…Œì´ë¸”ì´ë‹¤.
password ì»¬ëŸ¼ì€ ë¡œê·¸ì¸ ê²€ì¦ì„ ìœ„í•´ ë°˜ë“œì‹œ í•„ìš”í•˜ë¯€ë¡œ ì¶”ê°€í•´ë‘ì—ˆë‹¤.

```sql
CREATE TABLE users (
  id BIGINT AUTO_INCREMENT PRIMARY KEY,
  name VARCHAR(50) NOT NULL,
  email VARCHAR(100) NOT NULL UNIQUE, /* IDê°’ ì²˜ëŸ¼ ì“°ì¼ ì •ë³´ */
  password VARCHAR(255) NOT NULL,
  role VARCHAR(20),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```
---
## âœ… í´ë˜ìŠ¤ ì •ì˜
### User ì—”í‹°í‹° í´ë˜ìŠ¤ ìƒì„±
- Spring JPAë¥¼ ì‚¬ìš©í•´ users í…Œì´ë¸”ê³¼ ë§¤í•‘ë˜ëŠ” User í´ë˜ìŠ¤ ìƒì„±

### UserRepository ì¸í„°í˜ì´ìŠ¤ ìƒì„±
- JPAë¥¼ ì‚¬ìš©í•´ ì´ë©”ì¼ë¡œ ì‚¬ìš©ìë¥¼ ì¡°íšŒí•  ìˆ˜ ìˆëŠ” Repository ìƒì„±

### JwtTokenProvider í´ë˜ìŠ¤ ìƒì„±
> - ë¡œê·¸ì¸ ì„±ê³µ ì‹œ JWT Access Token ìƒì„±
- ìš”ì²­ í—¤ë”ì— ë‹´ê¸´ í† í°ì—ì„œ ìœ ì € ì •ë³´ ì¶”ì¶œ
- í† í°ì˜ ìœ íš¨ì„± ê²€ì¦

**JWT ìƒì„± ë° ê²€ì¦ì„ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤**ë¡œ, ë¡œê·¸ì¸ ì„±ê³µ ì‹œ í† í°ì„ ë°œê¸‰í•˜ê³ , ìš”ì²­ì´ ë“¤ì–´ì˜¬ ë•Œ í† í°ì„ ê²€ì¦í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

JWT í† í° ìƒì„±ì„ ìœ„í•´ **JJWT(Json Web Token)** Maven ì˜ì¡´ì„±ì„ ì¶”ê°€
```xml
<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt-api</artifactId>
  <version>0.11.5</version>
</dependency>
<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt-impl</artifactId>
  <version>0.11.5</version>
  <scope>runtime</scope>
</dependency>
<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt-jackson</artifactId>
  <version>0.11.5</version>
  <scope>runtime</scope>
</dependency>
```

```java
@Component
public class JwtTokenProvider {

    // ë¹„ë°€ í‚¤ 
    private final Key secretKey = Keys.secretKeyFor(SignatureAlgorithm.HS256);

    // í† í° ìœ íš¨ ì‹œê°„ (1ì‹œê°„)
    private final long validityInMilliseconds = 60 * 60 * 1000;

    // í† í° ìƒì„±
    public String createToken(String email, String role) {
        Claims claims = Jwts.claims().setSubject(email);
        claims.put("role", role);

        Date now = new Date();
        Date expiry = new Date(now.getTime() + validityInMilliseconds);

        return Jwts.builder()
                .setClaims(claims)
                .setIssuedAt(now)
                .setExpiration(expiry)
                .signWith(secretKey)
                .compact();
    }

    // ì´ë©”ì¼ ì¶”ì¶œ
    public String getEmail(String token) {
        return Jwts.parserBuilder().setSigningKey(secretKey).build()
                .parseClaimsJws(token).getBody().getSubject();
    }

    // í† í° ìœ íš¨ì„± ê²€ì‚¬
    public boolean validateToken(String token) {
        try {
            Jwts.parserBuilder().setSigningKey(secretKey).build()
                .parseClaimsJws(token);
            return true;
        } catch (JwtException | IllegalArgumentException e) {
            return false;
        }
    }
}
```

### SecurityConfig í´ë˜ìŠ¤ ìƒì„±

JWT ê¸°ë°˜ ì¸ì¦ êµ¬ì¡°ë¥¼ ìœ„í•´ Spring Security ì„¤ì •ì„ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•œë‹¤.

| ì„¤ì • í•­ëª©                         | ì„¤ëª…                                                             |
| --------------------------------- | ---------------------------------------------------------------- |
| `csrf().disable()`                | JWTëŠ” ì„¸ì…˜ì„ ì‚¬ìš©í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— CSRF ë°©ì–´ê°€ í•„ìš” ì—†ìŒ          |
| `sessionManagement().stateless()` | JWTëŠ” Stateless ì¸ì¦ ë°©ì‹ì´ë¯€ë¡œ ì„¸ì…˜ ì €ì¥ì´ ë¶ˆí•„ìš”               |
| `authorizeHttpRequests()`         | ë¡œê·¸ì¸, íšŒì›ê°€ì… ìš”ì²­ì€ í—ˆìš©í•˜ê³  ë‚˜ë¨¸ì§€ ìš”ì²­ì€ ì¸ì¦ í•„ìš”         |
| `addFilterBefore()`               | JWT ì¸ì¦ í•„í„°ë¥¼ `UsernamePasswordAuthenticationFilter` ì•ì— ë“±ë¡ |
| `passwordEncoder()`               | ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”ë¥¼ ìœ„í•´ `BCryptPasswordEncoder` ë¹ˆì„ ë“±ë¡         |



#### Spring Securityë€?

`Spring Security`ëŠ” Spring ìƒíƒœê³„ì—ì„œ ì‚¬ìš©ì ì¸ì¦(Authentication), ê¶Œí•œ ì œì–´(Authorization),  
ì•”í˜¸í™”, ë³´ì•ˆ í•„í„° ì²˜ë¦¬ ë“±ì„ ì±…ì„ì§€ëŠ” í•„ìˆ˜ ë³´ì•ˆ í”„ë ˆì„ì›Œí¬ì´ë‹¤.

#### ì£¼ìš” íŠ¹ì§•
- ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬ ìë™í™”
- JWT, ì„¸ì…˜, OAuth2 ë“± ë‹¤ì–‘í•œ ì¸ì¦ ë°©ì‹ ì§€ì›
- í•„í„° ê¸°ë°˜ì˜ ìœ ì—°í•œ êµ¬ì¡° â†’ JWT ì¸ì¦ì— ìµœì í™” ê°€ëŠ¥
- ë¹„ë°€ë²ˆí˜¸ ì•”í˜¸í™”(BCrypt) ë° ì‚¬ìš©ì ê¶Œí•œ ì²´í¬ ê¸°ëŠ¥ í¬í•¨

> ğŸ“Œ ì¦‰, Spring SecurityëŠ” ë³´ì•ˆ ê¸°ëŠ¥ ì „ë°˜ì„ ì±…ì„ì§€ëŠ” ìŠ¤í”„ë§ì˜ ê³µì‹ ë³´ì•ˆ ëª¨ë“ˆì´ë‹¤.


#### ğŸ›  Spring Security ì˜ì¡´ì„± ì¶”ê°€ (Maven)

`org.springframework.security` ê´€ë ¨ ë¹¨ê°„ì¤„ì´ ëœ° ê²½ìš°, ì•„ë˜ ì˜ì¡´ì„±ì„ `pom.xml`ì— ì¶”ê°€í•´ì•¼ í•œë‹¤:

```xml
<dependency>
  <groupId>org.springframework.boot</groupId>
  <artifactId>spring-boot-starter-security</artifactId>
</dependency>
```

### CustomUserDetailsService í´ë˜ìŠ¤ ìƒì„±
- Spring SecurityëŠ” ë¡œê·¸ì¸ ì‹œ UserDetailsService.loadUserByUsername() ë¥¼ í˜¸ì¶œí•¨
- ì¡°íšŒëœ ì‚¬ìš©ìë¥¼ UserDetails ê°ì²´ë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜

### JwtAuthenticationFilter í´ë˜ìŠ¤ ìƒì„±
> - ë§¤ ìš”ì²­ë§ˆë‹¤ JWT í† í°ì´ Authorization í—¤ë”ì— ìˆëŠ”ì§€ í™•ì¸
- í† í°ì´ ìœ íš¨í•˜ë©´ ì‚¬ìš©ì ì •ë³´ë¥¼ SecurityContextì— ë“±ë¡
- ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì¸ì¦ ì—†ì´ ìš”ì²­ í†µê³¼ (Spring Securityê°€ 403 ë°˜í™˜)

#### í•µì‹¬ íë¦„ ìš”ì•½
1. Authorization: Bearer {token} í˜•ì‹ì˜ ìš”ì²­ì—ì„œ í† í° ì¶”ì¶œ

2. ìœ íš¨ì„± ê²€ì‚¬ â†’ ì•„ì´ë””(ì´ë©”ì¼) ì¶”ì¶œ â†’ ì‚¬ìš©ì ì •ë³´ ë¡œë“œ

3. SecurityContextHolderì— ì¸ì¦ ê°ì²´ ì„¤ì •

4. ì¸ì¦ëœ ì‚¬ìš©ìë¡œ ì»¨íŠ¸ë¡¤ëŸ¬ ìš”ì²­ ì§„í–‰ ê°€ëŠ¥

---
## âœ… ë¡œê·¸ì¸ API (/login) ì»¨íŠ¸ë¡¤ëŸ¬
- AuthenticationManagerë¥¼ í†µí•´ email/password ê²€ì¦
- ê²€ì¦ ì„±ê³µ ì‹œ UserDetails ë°˜í™˜
- JWT ìƒì„± í›„ í´ë¼ì´ì–¸íŠ¸ì— ì „ë‹¬

***Controller***
```java
@RestController
@RequiredArgsConstructor
public class AuthController {

    private final AuthenticationManager authenticationManager;
    private final JwtTokenProvider jwtTokenProvider;
    private final CustomUserDetailsService userDetailsService;

    @PostMapping("/login")
    public ResponseEntity<?> login(@RequestBody LoginRequest request) {
        Authentication authentication = authenticationManager.authenticate(
                new UsernamePasswordAuthenticationToken(request.getEmail(), request.getPassword())
        );

        User user = (User) authentication.getPrincipal(); // org.springframework.security.core.userdetails.User

        String token = jwtTokenProvider.createToken(user.getUsername(), user.getAuthorities().iterator().next().getAuthority());

        return ResponseEntity.ok().body(token);
    }
}
```
***DTO***
```java
@Getter
@Setter
public class LoginRequest {
    private String email;
    private String password;
}

```

## ğŸ› ï¸ íŠ¸ëŸ¬ë¸”ìŠˆíŒ… ê¸°ë¡
JWT ê¸°ë°˜ ë¡œê·¸ì¸ êµ¬í˜„ í›„, Postmanìœ¼ë¡œ ë¡œê·¸ì¸ ìš”ì²­ ì‹œ ì•„ë˜ì™€ ê°™ì€ 403 Forbidden ì‘ë‹µì´ ë°˜ë³µ ë°œìƒ:

```
Failed to authenticate since password does not match stored value
```

**ë¡œê·¸ì¸ ìš”ì²­ ë‚´ìš©:**

```json
POST /login
{
  "email": "test@example.com",
  "password": "1234"
}
```
### ë””ë²„ê¹… ê³¼ì •

1. **ì…ë ¥ ê°’ê³¼ ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ í™•ì¸**

```java
System.out.println("ì…ë ¥ ë¹„ë°€ë²ˆí˜¸: " + request.getPassword());
System.out.println("ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ : " + user.getPassword());
```

ì¶œë ¥ ê²°ê³¼:

```
ì…ë ¥ ë¹„ë°€ë²ˆí˜¸: 1234
ì €ì¥ëœ ë¹„ë°€ë²ˆí˜¸ : $2a$10$L5Q0alHg8IRy8ZXzH4LC/O3KAHcrB4aGl9t0YiLKsHM9yGiizI3L2
```

2. **BCryptPasswordEncoder.matches()ë¡œ ì§ì ‘ ë¹„êµí•´ë³´ë‹ˆ false**

```java
PasswordEncoder encoder = new BCryptPasswordEncoder();
System.out.println(encoder.matches("1234", "$2a$10$L5Q0alHg8IRy8ZXzH4LC/..."));
// ê²°ê³¼: false
```
** ì›ì¸: ì €ì¥ëœ í•´ì‹œ ê°’ì´ í˜„ì¬ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ìƒì„±ëœ ê°’ì´ ì•„ë‹˜ â†’ í•´ì‹œ ë²„ì „ ë¶ˆì¼ì¹˜**

## ğŸ› ï¸ í•´ê²°

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì§ì ‘ ì•”í˜¸í™”ëœ ë¹„ë°€ë²ˆí˜¸ ìƒì„±

```java
PasswordEncoder encoder = new BCryptPasswordEncoder();
System.out.println(encoder.encode("1234"));
```

â†’ ì¶œë ¥ëœ ê°’:

```
$2a$10$X3HZ0UlZ9GmK/pfXeymJ9eZlRSEj4FL6dxRWqxz3dy3wCVjDHvnB6
```

### 2. í•´ë‹¹ ê°’ìœ¼ë¡œ DB ìˆ˜ë™ ì—…ë°ì´íŠ¸

```sql
UPDATE users
SET password = '$2a$10$X3HZ0UlZ9GmK/pfXeymJ9eZlRSEj4FL6dxRWqxz3dy3wCVjDHvnB6'
WHERE email = 'test@example.com';
```

---

### ì¶”ê°€ë¡œ ì ìš©í•œ Spring Security ì„¤ì •

```java
@Bean
public PasswordEncoder passwordEncoder() {
    return new BCryptPasswordEncoder();
}

@Bean
public DaoAuthenticationProvider authenticationProvider() {
    DaoAuthenticationProvider provider = new DaoAuthenticationProvider();
    provider.setUserDetailsService(userDetailsService);
    provider.setPasswordEncoder(passwordEncoder()); 
    return provider;
}

@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    return http
        .csrf(csrf -> csrf.disable())
        .sessionManagement(sm -> sm.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
        .authorizeHttpRequests(auth -> auth
            .requestMatchers("/login", "/signup").permitAll()
            .anyRequest().authenticated()
        )
        .authenticationProvider(authenticationProvider()) 
        .addFilterBefore(new JwtAuthenticationFilter(jwtTokenProvider, userDetailsService),
                         UsernamePasswordAuthenticationFilter.class)
        .build();
}

@Bean
public AuthenticationManager authenticationManager(AuthenticationConfiguration config) throws Exception {
    return config.getAuthenticationManager();
}
```
### ğŸ§  ê²°ê³¼

- Postmanì—ì„œ ë¡œê·¸ì¸ ìš”ì²­ ì„±ê³µ
- JWT í† í° ì •ìƒ ë°œê¸‰:

```
eyJhbGciOiJIUzI1NiJ9...
```

- ì´í›„ ì¸ì¦ì´ í•„ìš”í•œ API ì ‘ê·¼ ì‹œ Authorization í—¤ë”ì— í† í° ì¶”ê°€í•˜ì—¬ ì‚¬ìš© ê°€ëŠ¥
![](https://velog.velcdn.com/images/kjr04205/post/a7ad2edd-83c4-408c-b468-98937f6a8efa/image.png)

### ğŸ’¡ ë°°ìš´ ì 

| í•­ëª©                                                    | ë‚´ìš©                                       |
| ------------------------------------------------------- | ------------------------------------------ |
| BCrypt í•´ì‹œëŠ” ë™ì¼ í™˜ê²½ì—ì„œ ìƒì„±/ê²€ì¦í•´ì•¼ í•¨            | ë°˜ë“œì‹œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë‚´ë¶€ì—ì„œ encode() í•„ìš” |
| Spring SecurityëŠ” `.authenticationProvider()` ëª…ì‹œ í•„ìš” | ì»¤ìŠ¤í…€ `UserDetailsService`ë¥¼ ì‚¬ìš©í•  ê²½ìš°  |
| `AuthenticationManager`ëŠ” ìˆ˜ë™ ë“±ë¡í•´ì•¼ í•¨              | Spring Boot 3.x ì´ìƒì—ì„  ìë™ ìƒì„± ì•ˆë¨    |

## ğŸ”š ë§ˆë¬´ë¦¬
Spring Securityì™€ JWT í† í° ì¸ì¦ì„ ì²˜ìŒ ì ‘í•˜ë©´ì„œ ë§¤ë‰´ì–¼ì„ ë³´ë©´ì„œ ì„¤ì •ì„ í•˜ëŠ”ë°ë„,,,, ë””ë²„ê¹…ì„ í•˜ëŠ”ë°ë„,,,, ë‚´ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì–´ë”˜ê°€ì—ì„œ ì—ëŸ¬ê°€ ë‚˜ëŠ” ìƒí™©ì´ë¼ ì •ë§ ë§‰ë§‰í–ˆë‹¤. 

í•˜ì§€ë§Œ, í¬ê¸°í•˜ì§€ì•Šê³  í•œê³³í•œê³³ì”© ë¡œê·¸ë¥¼ ì°ì–´ë³´ë©´ì„œ ê²°êµ­ í•´ê²°í•  ìˆ˜ ìˆì—ˆë‹¤.!!!

ì´ë²ˆ ê²½í—˜ì„ í†µí•´ ì•”í˜¸í™”ëœ ê°’ì€ í•­ìƒ encode â†’ ì €ì¥ â†’ matchesë¡œ ê²€ì¦ì´ë¼ëŠ” ì‚¬ì´í´ì„ ëª…í™•íˆ ì´í•´í•˜ê²Œ ë˜ì—ˆë‹¤.

ë‚´ì¼ í™”ë©´ì—ì„œ íšŒì›ê°€ì…ì„ í•˜ê³ , ë¡œê·¸ì¸í•˜ëŠ” ê²ƒì„ ì²˜ë¦¬í•˜ë©´ì„œ ë‹¤ì‹œ ë³µìŠµí•´ë³´ì!

### Backend Repository : [GitHub](https://github.com/anhyoin97/mes-backend)